<!DOCTYPE html>
<html>
  <head>
    <title>Google Maps API Example</title>
    <link
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.16/dist/tailwind.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      type="text/css"
      href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css"
    />
    <style>
      /* Set the map container height */
      #map {
        height: 600px;
      }
    </style>
  </head>
  <body class="bg-gray-100">
    <section class="mt-12">
      <div class="py-8 px-4 mx-auto max-w-screen-xl text-center">
        <div class="flex flex-row my-auto justify-center space-x-4 mx-auto">
          <img src="/img/kpl-logo.png" class="w-16 h-16" />
          <h1 class="mb-4 text-4xl font-extrabold tracking-tight leading-none bg-clip-text text-transparent bg-gradient-to-r from-red-500 via-yellow-300 to-green-500 md:text-5xl lg:text-6xl dark:text-white">
            Address Lookup
          </h1>
        </div>
        <p class="text-lg font-normal text-gray-500 lg:text-xl sm:px-16 xl:px-48 dark:text-gray-400">
          Please enter an address to check whether or not it's eligible for a
          library card.
        </p>
      </div>
    </section>
    <section
      id="main"
      class="flex flex-col justify-center mx-auto space-y-6 max-w-screen-lg"
    >
      <div>
        <label for="hs-trailing-button-add-on" class="sr-only">Label</label>
        <div class="flex rounded-lg shadow-sm">
          <input
            id="search"
            type="text"
            placeholder="Search for an address"
            class="py-5 px-4 block w-full border-gray-200 hover:shadow-lg shadow-sm rounded-lg text-lg focus:z-10 focus:border-blue-500 focus:ring-blue-500 transition-all"
          />
        </div>
      </div>
      <div id="map" class="rounded-lg"></div>
      <div id="history" class="">
        <table id="historyTable" class="hidden w-full text-sm text-left text-gray-500 dark:text-gray-400">
            <thead class="text-xs text-gray-700 uppercase bg-white dark:bg-gray-700 dark:text-gray-400">
                <tr>
                    <th scope="col" class="px-6 py-3">
                        Address
                    </th>
                    <th scope="col" class="px-6 py-3">
                        Eligibile
                    </th>
                </tr>
            </thead>
            <tbody id="historyBody">

            </tbody>
        </table>    
      </div>
    </section>

    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCdffovvNp56s3SwmGaSlLmECmKFQqZwsw&libraries=places"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script>
      // Define global variables
      var map;
      var searchBox;
      var boundary;
      var historyTable;

      function initMap() {
        // Create a map centered on Kalamazoo, Michigan
        map = new google.maps.Map(document.getElementById("map"), {
          center: { lat: 42.2917, lng: -85.5872 }, // Kalamazoo, Michigan coordinates
          zoom: 9, // Adjust the initial zoom level as needed
        });

        // Create a circle overlay with a 30-mile radius around Kalamazoo
        var circle = new google.maps.Circle({
          center: { lat: 42.2917, lng: -85.5872 }, // Kalamazoo, Michigan coordinates
          radius: 30 * 1609.34, // 30 miles converted to meters
          strokeColor: "#FF0000",
          strokeOpacity: 0.8,
          strokeWeight: 2,
          fillColor: "#FF0000",
          fillOpacity: 0.35,
          map: map,
        });

        // Set the circle as the boundary
        boundary = circle;

        // Create a search box and link it to the UI element
        searchBox = new google.maps.places.SearchBox(
          document.getElementById("search")
        );

        // Get a reference to the history table
        historyTable = document.getElementById("historyTable").getElementsByTagName("tbody")[0];

        // Listen for the event fired when the user selects a prediction and retrieve more details
        searchBox.addListener("places_changed", checkEligibility);

          function checkEligibility() {
          var places = searchBox.getPlaces();

          if (places.length === 0) {
            return;
          }

          // Get the selected place's location
          var place = places[0];
          var location = place.geometry.location;

          // Check if the location is inside the boundary
          var isInsideBoundary =
            google.maps.geometry.spherical.computeDistanceBetween(
              location,
              circle.getCenter()
            ) <= circle.getRadius();

          if (!isInsideBoundary) {
            // Display failure toast and show the address on the map if outside the boundary
            Toastify({
              text: `${place.formatted_address} is not eligible`,
              duration: 3000,
              gravity: "top", // `top` or `bottom`
              position: "right", // `left`, `center` or `right`
              stopOnFocus: true, // Prevent dismissing of toast on hover
              style: {
                background: "linear-gradient(to right, #e8172f, #d42b35)",
                width: "400px", // Adjust the width as needed
                "max-width": "90%", // Adjust the maximum width as needed
                "font-size": "21px", // Adjust the font size as needed
              },
            }).showToast();

            // Show the address on the map
            var infowindow = new google.maps.InfoWindow({
              content: place.formatted_address,
            });
            var marker = new google.maps.Marker({
              position: location,
              map: map,
            });
            marker.addListener("click", function () {
              infowindow.open(map, marker);
            });
            infowindow.open(map, marker);
            const row = document.createElement('tr');
row.className = "bg-white border-t-2 border-b-2 dark:bg-gray-900 dark:border-gray-700";

const th = document.createElement('th');
th.className = "px-6 py-4 font-medium text-gray-900 whitespace-nowrap dark:text-white";
th.textContent = `${place.formatted_address}`

const td = document.createElement('td');
td.className = "px-6 py-4";
td.textContent = "No";

row.appendChild(th);
row.appendChild(td);

const tableBody = document.getElementById('historyBody');
if (document.getElementById('historyTable').classList.contains('hidden')) {
  document.getElementById('historyTable').classList.remove('hidden');
}
const firstRow = tableBody.firstChild;
if (firstRow) {
tableBody.insertBefore(row, firstRow);
} else {
  historyTable.appendChild(row);
}
          } else {
            // Display success toast and show the address on the map if inside the boundary
            Toastify({
              text: `${place.formatted_address} is eligible`,
              duration: 3000,
              gravity: "top", // `top` or `bottom`
              position: "right", // `left`, `center` or `right`
              stopOnFocus: true, // Prevent dismissing of toast on hover
              style: {
                background: "linear-gradient(to right, #27d895, #36c98b)",
                width: "400px", // Adjust the width as needed
                "max-width": "90%", // Adjust the maximum width as needed
                "font-size": "21px", // Adjust the font size as needed
              },
            }).showToast();

            // Show the address on the map
            var infowindow = new google.maps.InfoWindow({
              content: place.formatted_address,
            });
            var marker = new google.maps.Marker({
              position: location,
              map: map,
            });
            marker.addListener("click", function () {
              infowindow.open(map, marker);
            });
            infowindow.open(map, marker);

            const row = document.createElement('tr');
row.className = "bg-white border-t-2 border-b-2 dark:bg-gray-900 dark:border-gray-700";

const th = document.createElement('th');
th.className = "px-6 py-4 font-medium text-gray-900 whitespace-nowrap dark:text-white";
th.textContent = `${place.formatted_address}`

const td = document.createElement('td');
td.className = "px-6 py-4";
td.textContent = "Yes";

row.appendChild(th);
row.appendChild(td);

const tableBody = document.getElementById('historyBody');
if (document.getElementById('historyTable').classList.contains('hidden')) {
  document.getElementById('historyTable').classList.remove('hidden');
}
const firstRow = tableBody.firstChild;
if (firstRow) {
tableBody.insertBefore(row, firstRow);
} else {
  historyTable.appendChild(row);
}
}
          }
      }

      // Call the initialization function after the Google Maps API has loaded
      google.maps.event.addDomListener(window, "load", function () {
        initMap();
      });


    </script>
  </body>
</html>
