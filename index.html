<!DOCTYPE html>
<html>
  <head>
    <title>Google Maps API Example</title>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.3.1/mapbox-gl.css" rel="stylesheet" />
    <script src='https://unpkg.com/@turf/turf@6/turf.min.js'></script>
    <link
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.16/dist/tailwind.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      type="text/css"
      href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css"
    />
    <style>
      /* Set the map container height */
      #map {
        height: 600px;
      }

      svg {
  /* Set initial transition properties */
  transition-property: stroke-width;
  transition-duration: 500ms;
  transition-timing-function: ease-in-out;
  stroke-width: 1.5; /* Initial stroke width */
}

a:hover svg {
  transition-property: stroke-width;
  transition-duration: 500ms;
  transition-timing-function: ease-in-out;
}

a:hover svg {
  stroke-width: 2;
}

svg:hover {
  stroke-width: 2; /* Target stroke width on hover */
}
    </style>
  </head>
  <body class="bg-gray-100">

<nav class="bg-gray-100 border-gray-200 dark:bg-gray-900">
  <div class="max-w-screen flex flex-wrap items-center justify-between mx-auto p-4">
    <a href="https://my.kpl.gov/" class="transform hover:scale-105 duration-500 ease-in-out">
    <div class="flex flex-row whitespace-nowrap items-center space-x-4">
      <svg class="w-8 h-8" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18"></path>
      </svg>
      <p class="font-semibold text-lg text-gray-900 bg-clip-text hover:text-transparent bg-gradient-to-r from-red-500 via-yellow-300 to-green-500 transition duration-500">Back to MyKPL</p>
    </div>
  </a>
    <button data-collapse-toggle="navbar-default" type="button" class="inline-flex items-center p-2 w-10 h-10 justify-center text-sm text-gray-500 rounded-lg md:hidden hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-200 dark:text-gray-400 dark:hover:bg-gray-700 dark:focus:ring-gray-600" aria-controls="navbar-default" aria-expanded="false">
        <span class="sr-only">Open main menu</span>
        <svg fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18"></path>
        </svg>
    </button>
  </div>
</nav>

    <section class="mt-6">
      <div class="py-8 px-4 mx-auto max-w-screen-xl text-center">
        <div class="flex flex-row my-auto justify-center space-x-4 mx-auto">
          <img src="/img/kpl-logo.png" class="w-16 h-16" />
          <h1 class="mb-4 text-4xl font-extrabold tracking-tight leading-none bg-clip-text text-transparent bg-gradient-to-r from-red-500 via-yellow-300 to-green-500 md:text-5xl lg:text-6xl dark:text-white">
            Address Lookup
          </h1>
        </div>
        <p class="text-lg font-normal text-gray-500 lg:text-xl sm:px-16 xl:px-48 dark:text-gray-400">
          Please enter an address to check whether or not it's eligible for a
          library card.
        </p>
      </div>
    </section>
    <section
      id="main"
      class="flex flex-col justify-center mx-auto space-y-6 max-w-screen-lg"
    >

        
      </div>
      <div id="map" class="rounded-lg"></div>
      <div id="history" class="">
        <table id="historyTable" class="hidden mb-6 mt-4 w-full text-sm text-left text-gray-500 dark:text-gray-400">
            <thead class="text-xs text-gray-700 uppercase bg-white dark:bg-gray-700 dark:text-gray-400">
                <tr class="relative">
                    <th scope="col" class="px-6 py-3">
                        Address
                    </th>
                    <th scope="col" class="px-6 py-3">
                        Eligibile
                    </th>
                    <th class="absolute top-1/4 right-2 my-auto">
                      <button title="Clear history" onclick="clearTable()">
                        <svg class="w-4 h-4 my-auto items-center text-red-500" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0"></path>
                        </svg>
                      </button>
                    </th>
                    
                    
                </tr>
            </thead>
            <tbody id="historyBody">

            </tbody>
        </table>    
      </div>
    </section>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.3.1/mapbox-gl.js"></script>
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.7.0/mapbox-gl-geocoder.min.js"></script>
    <link
      rel="stylesheet"
      type="text/css"
      href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.7.0/mapbox-gl-geocoder.css"
    />
    <script>
      // Define global variables
      var map;
      var boundary;
      var historyTable;

      function initMap() {
        // Create a map centered on Kalamazoo, Michigan
        mapboxgl.accessToken = 'pk.eyJ1IjoibHVjYXNjYW1wYmVsbCIsImEiOiJjbGs0MnQxcTAwbTU1M2ZtcjA2ZXU0cDZqIn0.frU8JiLhGAEKgzD6qfiHAg';
        map = new mapboxgl.Map({
          container: 'map',
          style: 'mapbox://styles/mapbox/streets-v11',
          center: [-85.5872, 42.2917], // Kalamazoo, Michigan coordinates
          zoom: 9, // Adjust the initial zoom level as needed
        });


        map.on('load', function () {
  var kalamazoo = turf.point([-85.5872, 42.2917]);
  var radius = 5; // 5 miles

  var options = { steps: 100, units: 'miles' };
  var circle = turf.circle(kalamazoo, radius, options);

  map.addSource('circle', {
    type: 'geojson',
    data: circle
  });

  map.addLayer({
    id: 'circle',
    type: 'fill',
    source: 'circle',
    paint: {
      'fill-color': '#FF0000',
      'fill-opacity': 0.35
    }
  });

  // Set the circle as the boundary
  boundary = circle;
});



// Add the control to the map.
const geocoder = new MapboxGeocoder({
accessToken: mapboxgl.accessToken,
mapboxgl: mapboxgl,
placeholder: 'Search for an address'
});
 
map.addControl(geocoder);
        // Get a reference to the history table
        historyTable = document.getElementById("historyTable").getElementsByTagName("tbody")[0];

        geocoder.on('result', function (result) {
  // Get the selected place's location
  var place = result.result;
  var location = place.center;
  var address_raw = result.result.place_name;
  var address = result.result.address + ' ' + result.result.text
          console.log(result.result);
  // Create a Turf.js point feature from the location
  var point = turf.point([location[0], location[1]]);

  // Check if the point is within the circle
  var isInsideBoundary = turf.booleanPointInPolygon(point, boundary);

          if (!isInsideBoundary) {
            // Display failure toast and show the address on the map if outside the boundary
            Toastify({
              text: address + " is not eligible",
              duration: 3000,
              gravity: "top", // `top` or `bottom`
              position: "right", // `left`, `center` or `right`
              stopOnFocus: true, // Prevent dismissing of toast on hover
              style: {
                background: "linear-gradient(to right, #e8172f, #d42b35)",
                width: "400px", // Adjust the width as needed
                "max-width": "90%", // Adjust the maximum width as needed
                "font-size": "21px", // Adjust the font size as needed
              },
            }).showToast();

            // Show the address on the map
            var marker = new mapboxgl.Marker()
              .setLngLat(location)
              .addTo(map);
            var popup = new mapboxgl.Popup()
              .setLngLat(location)
              .setHTML(place.place_name)
              .addTo(map);
            marker.setPopup(popup);
            popup.addTo(map);

            const row = document.createElement('tr');
            row.className = "bg-white border-t-2 border-b-2 dark:bg-gray-900 dark:border-gray-700";

            const th = document.createElement('th');
            th.className = "px-6 py-4 font-medium text-gray-900 whitespace-nowrap dark:text-white";
            th.textContent = address_raw;

            const td = document.createElement('td');
            td.className = "px-6 py-4";
            td.textContent = "No";

            const td2 = document.createElement('td');
            td2.className = "px-6 py-4";
            td2.textContent = "";

            row.appendChild(th);
            row.appendChild(td);
            row.appendChild(td2);

            const tableBody = document.getElementById('historyBody');
            if (document.getElementById('historyTable').classList.contains('hidden')) {
              document.getElementById('historyTable').classList.remove('hidden');
            }
            const firstRow = tableBody.firstChild;
            if (firstRow) {
              tableBody.insertBefore(row, firstRow);
            } else {
              historyTable.appendChild(row);
            }
          } else {
            // Display success toast and show the address on the map if inside the boundary
            Toastify({
              text: address + " is eligible",
              duration: 3000,
              gravity: "top", // `top` or `bottom`
              position: "right", // `left`, `center` or `right`
              stopOnFocus: true, // Prevent dismissing of toast on hover
              style: {
                background: "linear-gradient(to right, #27d895, #36c98b)",
                width: "400px", // Adjust the width as needed
                "max-width": "90%", // Adjust the maximum width as needed
                "font-size": "21px", // Adjust the font size as needed
              },
            }).showToast();

            // Show the address on the map
            var marker = new mapboxgl.Marker()
              .setLngLat(location)
              .addTo(map);
            var popup = new mapboxgl.Popup()
              .setLngLat(location)
              .setHTML(place.place_name)
              .addTo(map);
            marker.setPopup(popup);
            popup.addTo(map);

            const row = document.createElement('tr');
            row.className = "bg-white border-t-2 border-b-2 dark:bg-gray-900 dark:border-gray-700";

            const th = document.createElement('th');
            th.className = "px-6 py-4 font-medium text-gray-900 whitespace-nowrap dark:text-white";
            th.textContent = address_raw;

            const td = document.createElement('td');
            td.className = "px-6 py-4";
            td.textContent = "Yes";

            const td2 = document.createElement('td');
            td2.className = "px-6 py-4";
            td2.textContent = "";
            
            row.appendChild(th);
            row.appendChild(td);
            row.appendChild(td2);

            const tableBody = document.getElementById('historyBody');
            if (document.getElementById('historyTable').classList.contains('hidden')) {
              document.getElementById('historyTable').classList.remove('hidden');
            }
            const firstRow = tableBody.firstChild;
            if (firstRow) {
              tableBody.insertBefore(row, firstRow);
            } else {
              historyTable.appendChild(row);
            }
          }
        });
      }
      // Call the initialization function after the page has loaded
      document.addEventListener("DOMContentLoaded", function () {
        initMap();
      });

      function clearTable() {
        document.getElementById('historyBody').innerHTML = '';
        document.getElementById('historyTable').classList.add('hidden');
      }
    </script>
  </body>
</html>
